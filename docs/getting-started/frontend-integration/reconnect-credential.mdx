---
sidebar_position: 5
---

import Button from '@site/src/components/Button';
import Tabs from '@theme/Tabs';
import TabItem from '@theme/TabItem';

# 4. Re-connect a credential

When a credential becomes disconnected or encounters authentication issues, users need a way to re-authenticate and resume collection.
The reconnection process varies depending on your integration approach.

---

## 1. Iframe integration (Quick & Easy)

For iframe-based integrations, reconnecting a credential is straightforward.

### Implementation

<table>
    <thead>
        <tr>
            <th>Step</th>
            <th>Side</th>
            <th>Description</th>
        </tr>
    </thead>
    <tbody>
        <tr>
            <td>1</td>
            <td>Frontend</td>
            <td>User clicks on the "Re-connect" button.</td>
        </tr>
        <tr>
            <td>2</td>
            <td>Frontend</td>
            <td>Update the iframe `href` to `/ui?token=${token}&credential_id=${credential_id}` and display the iframe.</td>
        </tr>
    </tbody>
</table>

The iframe will handle all the re-authentication steps automatically, including:
- Handling 2FA challenges
- Managing the collection process
- Providing real-time feedback to the user

### How it works

```mermaid
sequenceDiagram
    participant User
    participant Frontend as Your Frontend
    participant IFrame as Invoice-Collector iFrame
    participant API as Invoice-Collector API
    
    User->>Frontend: Clicks "Re-connect"
    Frontend->>IFrame: GET /ui?token={token}&credential_id={credential_id}
    IFrame->>API: POST /credential/{credential_id}/collect
    API-->>IFrame: Returns wsPath
    IFrame->>API: Establishes WebSocket connection /ws
    API-->>IFrame: Sends real-time updates
    IFrame-->>User: Shows progress
    User->>IFrame: Provides updates
    IFrame->>API: Sends updates via WebSocket
    API-->>IFrame: Sends progress updates
    IFrame-->>User: Shows progress
    IFrame-->>Frontend: Sends completion event
    Frontend-->>User: Closes iFrame
```

---

## 2. Full integration (Complete Control)

For full API integrations, you have complete control over the re-authentication flow.
The process is similar to adding a new credential, but starts with an existing credential.

### Implementation

<table>
    <thead>
        <tr>
            <th>Step</th>
            <th>Side</th>
            <th>Description</th>
        </tr>
    </thead>
    <tbody>
        <tr>
            <td>1</td>
            <td>Frontend</td>
            <td>Create a page to display re-connect progress.</td>
        </tr>
        <tr>
            <td>2</td>
            <td>Frontend</td>
            <td>User clicks on the "Re-connect" button.</td>
        </tr>
        <tr>
            <td>3</td>
            <td>Backend</td>
            <td>Call [`POST /credential/{credential_id}/collect`](/docs/api.mdx#tag/Credential-(bearer)/paths/~1user~1{user_id}~1credential~1{credential_id}~1collect/post) to start the reconnection process and return `wsPath` to your frontend.</td>
        </tr>
        <tr>
            <td>4</td>
            <td>Frontend</td>
            <td>Implement WebSocket connection `/ws` and events (state, screenshot, twofa, close).</td>
        </tr>
    </tbody>
</table>

### WebSocket Messages

The reconnection process uses the same WebSocket messages as credential addition:

**Messages Received from API:**

- **State** - Progress updates and state changes
- **Screenshot** - For interactive login when needed

**Messages Sent to API:**

- **Twofa** - Two-factor authentication code
- **Click** - Mouse click simulation during interactive login
- **Keydown** - Keyboard input during interactive login
- **Text** - Text input during interactive login
- **Close** - Complete interactive login session

For detailed information about WebSocket messages, refer to the [Websocket Messages](../websocket-messages) documentation.

### How it works

```mermaid
sequenceDiagram
    participant User
    participant Frontend as Your Frontend
    participant Backend as Your Backend
    participant API as Invoice-Collector API
    
    User->>Frontend: Clicks "Re-connect"
    Frontend->>Backend: Request reconnection
    Backend->>API: POST /credential/{credential_id}/collect
    API-->>Backend: Returns wsPath
    Backend-->>Frontend: Returns wsPath
    Frontend->>API: Establishes WebSocket connection /ws
    API-->>Frontend: Sends real-time updates
    Frontend-->>User: Shows progress
    User->>Frontend: Provides updates
    Frontend->>API: Sends updates via WebSocket
    API-->>Frontend: Sends progress updates
    Frontend-->>User: Shows progress
    Frontend->>User: Shows completion message
```

---

## Common Scenarios

### 2FA & Session Expired

Some websites require 2FA for authentication. Cookies will be saved on first connection to authenticate on the next ones.
After few month, the token will expire and the user will have to re-authenticate.

- The credential `state.index` will go to `-2` and a `notification_disconnected` event will be sent to your callback.
- User is notified that the credential is disconnected and a re-authentication is required
- User clicks on "Re-connect"
